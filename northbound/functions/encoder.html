<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Document</title>
   <link rel="stylesheet" href="../../index.css">
   <link rel="stylesheet" href="functions.css">

</head>
<body>
   <div class="container">
      <div class="navigate-button">
         <a href="../../index.html" >Back to homepage</a>
         <a href="../northbound_options.html" >Back to Northbound menu</a>

      </div>
      <h2 class="title">NECTOR Encoder</h2>
      <div class="center-container">
         <p> Responsible for creating chunks and NC encoding at chunk-level etc.
         </p>
         <img src="assets/encoder_uvx.PNG" />
      </div>
      <h3>Three sub-functional blocks for NECTOR Encoder</h3>
      <ul>
         <li class="list-title"><br>Chunk Creator</br></li>
         <li class="underline"></li>
         <li>
            Segment VGRAM/file into chunks. Usually the number of chunks is 32. Not to high to avoid NC complexity.
         </li>
         <li>
            But, the chunk length is depended on ABR (average bit rate) for video coding, videogram duration and number of chunks.
         </li>
         <li>
            The only constant is number of chunks, so the other three are variable.
         </li>
         <li><b>Output of :Chunk Creator</b></li>
         <li>source chunk index number, source chunk size,source chunk payload</li>


         <li class="list-title"><br>NC Encoder</br></li>
         <li class="underline"></li>

         <li>
            Performs network coding using Pascal matrices to encode source chunks
         </li>
         <li><b>Inputs of :NC Encoder</b></li>
         <li>Source Chunks, Generation Size (number of chunks), Chunk Length, Field Size</li>
         <li>Output of: NC Encoder</li>
         <li>Coded Chunks are send when NECTOR client asks for more chunks after consulting the seeders and peers </li>
         <li>Coded Chunks  contains: Chunk size,Generation Index,Generation Size,Chunk type,NC coefficients,Payload</li>


         <li><br>Generate NECTOR File function</br></li>
         <li class="underline"></li>

         <li>
            There is a nector file for each VGRAM. The NECTOR Fixed Tracker then sends NECTOR File to the Peer (Leecher)
            at the C3 node.
         </li>
         <li>
            NECTOR file contains: File name, Nector file index, chunk hashes (verification), number of chunks, chunk length, last chunk length, creation time, expiration time, nector File-hash
         </li>
      </ul>

      <div class="content">
         <svg id="more-arrows">
           <polygon class="arrow-top" points="37.6,27.9 1.8,1.3 3.3,0 37.6,25.3 71.9,0 73.7,1.3 "/>
           <polygon class="arrow-middle" points="37.6,45.8 0.8,18.7 4.4,16.4 37.6,41.2 71.2,16.4 74.5,18.7 "/>
           <polygon class="arrow-bottom" points="37.6,64 0,36.1 5.1,32.8 37.6,56.8 70.4,32.8 75.5,36.1 "/>
         </svg>
       </div>
   
       <h2 class="title">NECTOR Encoder - Code</h2>
       <ul>

         <li class="list-title">nector-encoder.cc</li>
         <li class="underline2"></li>
         
         <li class="function-name"><u>Constructor (NECTOREncoder)</u></li>
         <li>Parameters: number of chunks, code Chunks scheme </li>
         <li>Function 1: Initizalise to null and 0 , pointers
            to nectorfile, inputdata, decoder and to 0 
            inputSize, nextChunkIndex, expirationTime</li>

         <li class="function-name"><u>Destryuctor (NECTOREncoder)</u></li>
         <li>Function 1: Declare a mutex and internal cleanup</li>

         <li class="function-name"><u>again clean Up (cleanup)</u></li>
         <li>Function 1: Declare a mutex and internal cleanup</li>

         <li class="function-name"><u>Internal cleanup (internal_cleanup)</u></li>
         <li>Function 1: Initialize inputdata pointer and input size</li>
         <li>Function 2: if there is a nectorFile delete it and the 
            pointer, close source file 
         </li>

         <li class="function-name"><u>Process new file from memory 
            (processNewFile_stage1)</u></li>
         <li>parameters: input Data, input Size, file Name, expiration Time</li>
         <li>Function 1: Start with new file (initialize variables with
            the parameters.
         </li>
         <li>Function 2: Initialize NECTOR File. (check for erros first) </li>


         <li class="function-name"><u>Process new file from memory 
            (processNewFile_stage1)</u></li>
         <li>parameters: input Data, input Size, file Name, expiration Time</li>
         <li>Function 1: Clean-up current resources</li>
         <li>Function 2: Start with new file</li>

         <li class="function-name"><u>Process new file from disk 
            (processNewFileFromDisk)</u></li>
         <li>parameters: file Name, expiration Time </li>
         <li>Function 1: mutex</li>
         <li>Function 2: Internal clean up first</li>
         <li>Function 3:  Start with new file, try to open the source file </li>
         <li>Function 4:  if its open then process the new file and debug </li>

         <li class="function-name"><u>Process new file from NECTORDecoder
            (processNewFileFromDecoder)</u></li>
         <li>parameters: decoder </li>
         <li>Function 1: mutex</li>
         <li>Function 2: internal cleanup</li>
         <li>Function 3: Initizalize some variables (decoder, nectorfile,
            inputData, input Size, expiration time, number of chunks
         </li>


         <li class="function-name"><u>Get pointer to NECTORFile
            (getNectorFile)</u></li>
         <li>parameters: decoder </li>
         <li>Function 1: mutex</li>
         <li>Function 1: mutex</li>

         <li class="function-name"><u>Get pointer to NECTORFile hash
            (getNectorFileHash)</u></li>
         <li>parameters: decoder </li>
         <li>Function 1: return hash nector file</li>

         <li class="function-name"><u>Get number of chunks
            (getChunkCount)</u></li>
         <li>parameters: decoder </li>
         <li>Function 1: return number of chunks</li>


         <li class="function-name"><u>Get pointer to chunk payload 
            (getChunkPayload)</u></li>
         <li>parameters: chunk Number, pointer, size </li>
         <li>Function 1: if there is input data then ,
            set the size and the pointer to the nector file.
         </li>

         <li class="function-name"><u>Check whether chunk from collector is good 
            (chunkIsGood)</u></li>
         <li>parameters: chunk Iterator, iterator, chunk reception status </li>
         <li>Function 1: ???????????????????</li>


         <li class="function-name"><u>Request uncoded chunk, get next chunk which
            is not already set in chunk Reception status. 
            (requestUncodedChunk)</u></li>
         <li>parameters: receiver In same Convoy boolean, chunk reception 
            status </li>
         <li>Function 1: mutex</li>
         <li>Function 2: is complete file available, then set next chunk
            index to the next chunk.</li>
         <li>Function 3: set m_NextChunkIndex to next chunk (make
            some check in the loop that follows)
         </li>
         <li>Function 4: check for error
             Uncoded Chunk did not find a new chunk.</li>
         <li>Function 5: Finally initialize variables such as payload
            and payload Size and finally "generated nector chunk" .</li>
         <li>Second part of the function:</li>
         <li>Function 1: This part handles the parts of the 
            file that are available from the decoder.
         </li>
         <li>Function 2: check if the nector file is null first and then lock the decoder</li>
         <li>Function 3: Before selection: check log</li>
         <li>Function 4: m_Chunk Map Iterator before selection</li>
         <li>Function 5: ??????????????????????</li>


         <li class="function-name"><u> Request coded chunk 
            (requestCodedChunk)</u></li>
         <li>parameters: receiver In Same Convoy boolean </li>
         <li>Function 1: mutex and check if there is input data file.</li>
         <li>Function 2: generate packet from encoder.</li>
         <li>Function 3: check if there is payload and if there is 
            then do a memory copy of it.</li>
         <li>Function 4: Finally, create the new chunk using
            new NECTORchunk with several parameters and check if it is 
            not null. </li>


            <li class="function-name"><u> Generate slices for chunk 
               (prepareSlices)</u></li>
            <li>parameters: nector Chunk, slices Settings </li>
            <li>Function 1: Check whether its a chunk that will
               provide coded slice or uncoded and prepare them</li>


         <li class="function-name"><u> Request slice 
            (requestSlice)</u></li>
         <li>parameters: nector Chunk, requested slice number </li>
         <li>Function 1: return requested Slice number</li>


         <li class="function-name"><u>GET NC flags 
            (calcFlagForNectorFile)</u></li>
         <li>Function 1: return NC flags (called chunkNC)</li>


         <li class="function-name"><u> Generate NECTOR File 
            (generateNECTORFile)</u></li>
         <li>Function 1: Calculate chunk sizes (otherChunkSize,
            chunkCount, last Chunk Size)</li>
         <li>Function 2: Initialise Nector File (time, 
            nector File size, file Name size)
         </li>
         <li>Function 3: Assert that the settings are useful</li>
         <li>Function 4: Initialise header ( nector file string,
            version, flags, file_size, chunk_count, last chunk size,
            other chunk size, creation time 
         </li>

         <li>Function 5: Initialise file name</li>
         <li>Function 6: Calculate chunk hashes and calulate 
            file hash.
         </li>
         <li>Function 7: finally print a log.</li>


         <li class="function-name"><u>Initialize network coding for chunks 
            (initAndFillNC)</u></li>
         <li>Function 1: Find number of chunks,settings, generation size</li>
         <li>Function 2: Filling up all source chunks to NC,
            pointer, size, get Chunk Payload Size</li>
         <li>Function 3: Encoder - > add Packet (pointer,size) </li>








         <li class="list-title">nector-chunk.cc</li>
         <li class="underline2"></li>
         
         <li class="function-name"><u>Constructor (NECTORChunk)</u></li>
         <li>Parameters:chunkSeqNumber, header, header_size,payload,payloadSize,
            chunk id, IsObtained from same convoy, delete payload </li>
         <li>Function 1: initialize some starting flags, sizes, indexes etc</li>


         <li class="function-name"><u>Another constructor (NECTORChunk)</u></li>
         <li>Parameters:type, nectorFileHash, payload (string), payloadSize,
            chunkSeqNumber, deletePayloadInDestructor, deleteSlicesinDestructor </li>
         <li>Function 1: initialize some starting flags, sizes, indexes etc</li>
         <li>Function 2: switch statement to determine header
            (common header, uncoded chunkheader, coded chunk)
         </li>
         <li>Function 3: initiazing some values to be set by prepareSlices()</li>


         <li class="function-name"><u>Destructor (NECTORChunk)</u></li>
         <li> </li>
         <li>Function 1: internal_cleanup</li>





         <li class="function-name"><u>Clean up (internal clean up)</u></li>
         <li>Function 1: initialize some starting flags, sizes, indexes etc</li>
         <li>Function 2: resetPayload()</li>
         <li>Function 3: initialize the iterator and iterate through 
            the slizes and delete them 
         </li>
         <li>Function 4: Reset the network encoding and decoding. </li>

         
         <li class="function-name"><u>Clean up (reset)</u></li>
         <li >Function 1: Run internal_cleanup</li>
         <li >Function 2: reset headers  and other flags</li>

         <li class="function-name"><u>Insert slice(insertSlice)</u></li>
         <li>Parameters: nectorSlice </li>
         <li>Function 1: If coded slice insert it as coded slice
            else insert it as uncoded slice.
         </li>


         <li class="function-name"><u>Insert uncoded slice(insertUncodedSlice)</u></li>
         <li>Parameters: nectorSlice </li>
         <li>Function 1: check if nector's type is ncht_uncoded.</li>
         <li>Function 2: get the slice iD.</li>
         <li>Function 3: Iterate through it and try to find the slice.</li>
         <li>Function 4: In the iteration run a command to find the
            slice and if alreayd there delete the old one
          </li>
          <li>Finally add the slice.</li>

          
         <li class="function-name"><u> Insert coded slice
            (insertCodedSlice)</u></li>
         <li>Parameters: nectorSlice </li>
         <li>Function 1:Do some starting checks ????</li>
         <li>Function 2: Add slice.</li>
         <li>???????????????????????????</li>


         <li class="function-name"><u> Get decoded data 
            (getDecodedData)</u></li>
         <li>Parameters: data, size </li>
         <li>Function 1: Do some starting checks ????</li>
         <li>Function 2: Get data for buffer and its size</li>


         <li class="function-name"><u>  Reassemble payload of coded slices 
            (reassemblePayloadFromCodedSlices)</u></li>
         <li>Parameters: data, size, srcOffSet </li>
         <li>Function 1: Initialize some starting data, null pointer and original size</li>
         <li>Function 2: run getDecodedData and check if they are not null</li>
         <li>Function 3: check the offset ranges and then memcopythe data</li>
      

         <li class="function-name"><u>   Check sequence of uncoded 
            slices (checkUncodedSlicesSequence)</u></li>
         <li>Parameters: total Chunks Size </li>
         <li>Function 1:Check sequence of slices 
            // Check that there is a sequence of slices (no gaps) </li>
         <li>Iterate through and find out if the sequence is correct??</li>

         
         <li class="function-name"><u>Reassemble payload of uncoded slices 
            (reassemblePayloadFromUncodedSlices) </u></li>
         <li>Parameters: data, size, srcOffset </li>
         <li>Function 1: initilize data , offset variables</li>
         <li>Function 2: Do a loop through the slices and 
            try to put the data into the memory in a sequence
         </li>
         <li>Function 3: Do some final checks</li>




         <li class="function-name"><u>Get first uncoded slice 
            (getFirstUncodedSlice) </u></li>
         <li>Function 1: check if its not empty and return the first slice</li>


      
         <li class="function-name"><u>Get slice type  
            (expectedSliceType) </u></li>
         <li>Function 1: return the slice type</li>


         <li class="function-name"><u>Prepare decoding of slices  
            (prepareDecodingSlices) </u></li>
         <li>Parameters: scheme</li>
         <li>Function 1: ?????????</li>


         
         <li class="function-name"><u>Output operator  
            (prepareDecodingSlices) </u></li>
         <li>Parameters: OS stream OS, nector Chunk</li>
         <li>Function 1: Switch statement with headers</li>
         <li>Function 2: Three headers: NCHT_UNKNOWN,
            NCHT_UNCODED, NCHT_CODED (first header is encoder 
            and decoder)</li>
         <li>Function 3: Print file,payload etc</li>


         <li class="function-name"><u>get type (getType) </u></li>
         <li>Function 1: return header type</li>

         <li class="function-name"><u>get total size (getTotalSize) </u></li>
         <li>Function 1: return header + payload size</li>

         <li class="function-name"><u>get header size(getHeaderSize) </u></li>
         <li>Function 1: return header size</li>

         <li class="function-name"><u>get header data(getHeaderData) </u></li>
         <li>Function 1: return header data</li>

         <li class="function-name"><u>get payload size(getPayloadSize) </u></li>
         <li>Function 1: return payload size</li>
         
         <li class="function-name"><u>get payload data(getPayloadData) </u></li>
         <li>Function 1: return payload data</li>

         <li class="function-name"><u>get payload data(getPayloadData) </u></li>
         <li>Function 1: return payload data</li>

         <li class="function-name"><u>get chunk sequence number(getChunkID) </u></li>
         <li>Function 1: return chunk ID</li>


         <li class="function-name"><u>Get slice size for uncoded slice
            (getUncodedSlicePayloadSize) </u></li>
         <li>Parameters: sliceNumber</li>
         <li>Function 1: ?????? </li>

         <li class="function-name"><u>Get slice count
            (getSliceCount) </u></li>
         <li>Function 1: get collector size </li>


         <li class="function-name"><u>Examine header
            (getUncodedSlicePayloadSize) </u></li>
         <li>Parameters: data, datalength, headerSize</li>
         <li>Function 1: Examine a NECTORChunkHeader in a data block. </li>
         <li>Function 2: On success return NECTORChunkHeaderUnion pointer
            and sets Header Size </li>
         <li>????????</li>


            <li class="function-name"><u> Initialise header
               (initHeader) </u></li>
            <li>Parameters: header pointer, headerSize</li>
            <li>Function 1: memcopy the header basically ??</li>

         <li class="function-name"><u>Initialise payload
            (initPayload) </u></li>
         <li>Parameters: data, size, deletePayloadInDestructor</li>
         <li>Function 1: if payload is not null, reset payload</li>   
         <li>Function 2: check if payload is really gone</li>   
         <li>Function 3: delete payload in destructor and initialize
            payload with data and payloadSize with size.
         </li>   

         
         <li class="function-name"><u>Reset payload 
            (resetPayload) </u></li>
         <li>Function 1: Delete m_payload and pointers, and size</li>   
    

         <li class="function-name"><u>Prepare uncoded slices
            (prepareUncodedSlices) </u></li>
         <li>Parameters: numberOfSlices</li>
         <li>Function 1: ????? Many calculations of slice sizes.????</li> 



         
         <li class="function-name"><u>Prepare coded slices
            (prepareCodedSlices) </u></li>
         <li>Parameters: slicesSettings</li>
         <li>Function 1: ????? Many calculations of slice sizes.????</li> 


         <li class="function-name"><u> Copy payload of uncoded slice 
            (copyUncodedSlicePayload) </u></li>
         <li>Parameters: payload, slizeSize, sliceNumber</li>
         <li>Function 1: Position inside the slice payload</li> 
         <li>Function 2:  Copy (part of) header</li> 
         <li>Function 3: Position inside the chunk [header + payload</li> 
         <li>Function 4: Begin writing payload data at this position</li> 
         <li>Function 5: Move input position ahead</li> 
         <li>Function 6: Copy payload</li> 

         <li class="function-name"><u>  Request uncoded slice 
            (requestUncodedSlice) </u></li>
         <li>Parameters: requestedSliceNumber</li>
         <li>Function 1: Get the right slice number</li> 
         <li>Function 2: Generate the slice payload (from chunk header+payload)</li> 
         <li>Function 3: Create slice</li> 


         <li class="function-name"><u>  Request coded slice
            (requestCodedSlice) </u></li>
         <li>Parameters: requestedSliceNumber</li>
         <li>Function 1:  Get the right slice number r</li> 
         <li>Function 2: Generate the slice payload (from chunk header+payload)</li> 
         <li>Function 3: Create slice</li> 

      </ul>
   </div>
</body>
</html>